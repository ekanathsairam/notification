
name: Teams Notification (Reusable)

on:
  workflow_call:
    inputs:
      notify_title:
        description: "Card title"
        type: string
        default: "GitHub Notification"
      theme_color:
        description: "Hex color (without #) for Teams card"
        type: string
        default: "0076D7"
    secrets:
      teams_webhook_url:
        description: "Teams Incoming Webhook URL"
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v4

      - name: Capture commit message safely
        shell: bash
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B || true)"
          {
            echo "COMMIT_MSG<<EOF"
            echo "${COMMIT_MSG}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Determine event details & build links
        shell: bash
        run: |
          REF_FULL="${GITHUB_REF}"
          if [[ "${REF_FULL}" == refs/tags/* ]]; then
            EVENT_TYPE="Tag Push"
            REF_NAME="${REF_FULL#refs/tags/}"
          else
            EVENT_TYPE="Workflow YAML Changed"
            REF_NAME="${REF_FULL#refs/heads/}"
          fi

          REPO_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          REF_URL="${REPO_URL}/tree/${REF_NAME}"
          COMMIT_URL="${REPO_URL}/commit/${GITHUB_SHA}"

          {
            echo "EVENT_TYPE=${EVENT_TYPE}"
            echo "REF_NAME=${REF_NAME}"
            echo "REF_URL=${REF_URL}"
            echo "COMMIT_URL=${COMMIT_URL}"
          } >> "$GITHUB_ENV"

      - name: Send Teams notification (MessageCard)
        env:
          TITLE: ${{ inputs.notify_title }}
          THEME_COLOR: ${{ inputs.theme_color }}
          TEAMS_WEBHOOK_URL: ${{ secrets.teams_webhook_url }}
        shell: bash
        run: |
          COMMIT_MSG_JSON=$(python3 - << 'PYCODE'
import json, os
print(json.dumps(os.environ.get("COMMIT_MSG","")))
PYCODE
)

          TMP_PAYLOAD="$(mktemp)"
          cat > "${TMP_PAYLOAD}" <<EOF
{
  "@type": "MessageCard",
  "@context": "https://schema.org/extensions",
  "summary": "${TITLE}",
  "themeColor": "${THEME_COLOR}",
  "title": "${TITLE} - ${EVENT_TYPE}",
  "sections": [
    {
      "facts": [
        { "name": "Repository",   "value": "${GITHUB_REPOSITORY}" },
        { "name": "Triggered By", "value": "${GITHUB_ACTOR}" },
        { "name": "Event",        "value": "${EVENT_TYPE}" },
        { "name": "Branch/Tag",   "value": "${REF_NAME}" },
        { "name": "Commit SHA",   "value": "${GITHUB_SHA}" },
        { "name": "Commit URL",   "value": "${COMMIT_URL}" }
      ],
      "text": ${COMMIT_MSG_JSON}
    }
  ],
  "potentialAction": [
    {
      "@type": "OpenUri",
      "name": "View Commit",
      "targets": [{ "os": "default", "uri": "${COMMIT_URL}" }]
    },
    {
      "@type": "OpenUri",
      "name": "View Branch/Tag",
      "targets": [{ "os": "default", "uri": "${REF_URL}" }]
    }
  ]
}
EOF

          curl -sS -X POST \
               -H "Content-Type: application/json" \
               --data @"${TMP_PAYLOAD}" \
               "${TEAMS_WEBHOOK_URL}"
