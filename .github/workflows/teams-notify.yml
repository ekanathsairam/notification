name: Teams Notification (Reusables)

on:
  workflow_call:
    inputs:
      notify_title:
        description: "Card title"
        type: string
        default: "GitHub Notification"
      theme_color:
        description: "Hex color (without #) for Teams card"
        type: string
        default: "0076D7"
    secrets:
      teams_webhook_url:
        description: "Teams Incoming Webhook URL"
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4

      - name: Capture commit message safely
        shell: bash
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B || echo 'No commit message found')"
          {
            echo "COMMIT_MSG<<EOF"
            echo "${COMMIT_MSG}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Determine event details & build links
        shell: bash
        run: |
          set -euo pipefail

          REF_FULL="${GITHUB_REF}"

          if [[ "${REF_FULL}" == refs/tags/* ]]; then
            echo "EVENT_TYPE=Tag Push" >> $GITHUB_ENV
            echo "REF_NAME=${REF_FULL#refs/tags/}" >> $GITHUB_ENV
          else
            echo "EVENT_TYPE=Workflow YAML Changed" >> $GITHUB_ENV
            echo "REF_NAME=${REF_FULL#refs/heads/}"  >> $GITHUB_ENV
          fi

          REPO_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          REF_URL="${REPO_URL}/tree/${REF_NAME}"
          COMMIT_URL="${REPO_URL}/commit/${GITHUB_SHA}"

          {
            echo "EVENT_TYPE=${EVENT_TYPE}"
            echo "REF_NAME=${REF_NAME}"
            echo "REF_URL=${REF_URL}"
            echo "COMMIT_URL=${COMMIT_URL}"
          } >> "$GITHUB_ENV"

      - name: Build JSON payload with jq
        env:
          TITLE: ${{ inputs.notify_title }}
          THEME_COLOR: ${{ inputs.theme_color }}
        shell: bash
        run: |
          set -euo pipefail

          jq -n \
            --arg title "$TITLE" \
            --arg color "$THEME_COLOR" \
            --arg repo "$GITHUB_REPOSITORY" \
            --arg actor "$GITHUB_ACTOR" \
            --arg event "$EVENT_TYPE" \
            --arg refname "$REF_NAME" \
            --arg sha "$GITHUB_SHA" \
            --arg commit_url "$COMMIT_URL" \
            --arg ref_url "$REF_URL" \
            --arg commit_msg "$COMMIT_MSG" \
            '{
              "@type": "MessageCard",
              "@context": "https://schema.org/extensions",
              summary: $title,
              themeColor: $color,
              title: ($title + " - " + $event),
              sections: [
                {
                  facts: [
                    { "name": "Repository",   "value": $repo },
                    { "name": "Triggered By", "value": $actor },
                    { "name": "Event",        "value": $event },
                    { "name": "Branch/Tag",   "value": $refname },
                    { "name": "Commit SHA",   "value": $sha },
                    { "name": "Commit URL",   "value": $commit_url }
                  ],
                  text: $commit_msg
                }
              ],
              potentialAction: [
                {
                  "@type": "OpenUri",
                  "name": "View Commit",
                  "targets": [
                    { "os": "default", "uri": $commit_url }
                  ]
                },
                {
                  "@type": "OpenUri",
                  "name": "View Branch/Tag",
                  "targets": [
                    { "os": "default", "uri": $ref_url }
                  ]
                }
              ]
            }' > payload.json

          echo "PAYLOAD_FILE=payload.json" >> "$GITHUB_ENV"

      - name: Send Teams notification
        run: |
          payload=$(cat << EOF
          {
            "title": "GitHub Notification - $EVENT_TYPE",
            "text": "**Repository:** ${GITHUB_REPOSITORY}

                     **Triggered By:** ${GITHUB_ACTOR}

                     **Event:** ${EVENT_TYPE}

                     **Branch/Tag:** ${REF_NAME}

                     **Commit SHA:** ${GITHUB_SHA}

                     **Message:** ${COMMIT_MSG}"
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
               -d "$payload" \
               ${{ secrets.TEAMS_WEBHOOK_URL }}
