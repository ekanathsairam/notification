
name: Teams Notification (Reusable)

on:
  workflow_call:
    inputs:
      notify_title:
        description: "Card title"
        type: string
        default: "GitHub Notification"
      theme_color:
        description: "Hex color (without #) for Teams card"
        type: string
        default: "0076D7"
    secrets:
      teams_webhook_url:
        description: "Teams Incoming Webhook URL"
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4

      - name: Capture commit message safely
        shell: bash
        run: |
          # Get the latest commit message; allow empty if not present
          COMMIT_MSG="$(git log -1 --pretty=%B || echo "No commit message found")"
          {
            echo "COMMIT_MSG<<EOF"
            echo "${COMMIT_MSG}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Determine event details & build links
        shell: bash
        run: |
          set -euo pipefail
          REF_FULL="${GITHUB_REF}"
          if [[ "${REF_FULL}" == refs/tags/* ]]; then
            EVENT_TYPE="Tag Push"
            REF_NAME="${REF_FULL#refs/tags/}"
          else
            EVENT_TYPE="Workflow YAML Changed"
            REF_NAME="${REF_FULL#refs/heads/}"
          fi

          REPO_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          REF_URL="${REPO_URL}/tree/${REF_NAME}"
          COMMIT_URL="${REPO_URL}/commit/${GITHUB_SHA}"

          {
            echo "EVENT_TYPE=${EVENT_TYPE}"
            echo "REF_NAME=${REF_NAME}"
            echo "REF_URL=${REF_URL}"
            echo "COMMIT_URL=${COMMIT_URL}"
          } >> "$GITHUB_ENV"

      - name: JSON-escape commit message (jq, no Python/Node)
        shell: bash
        run: |
          # Convert COMMIT_MSG into a JSON string (escape quotes/newlines safely)
          # -R: read raw string, -s: slurp entire input as a single string
          COMMIT_MSG_JSON=$(printf '%s' "${COMMIT_MSG}" | jq -Rs .)
          echo "COMMIT_MSG_JSON=${COMMIT_MSG_JSON}" >> "$GITHUB_ENV"

      - name: Build payload (quoted heredoc to avoid interpolation)
        shell: bash
        run: |
          set -euo pipefail

          payload_file="$(mktemp)"
          cat << 'EOF' > "${payload_file}"
{
  "@type": "MessageCard",
  "@context": "https://schema.org/extensions",
  "summary": "___TITLE___",
  "themeColor": "___THEME_COLOR___",
  "title": "___TITLE___ - ___EVENT_TYPE___",
  "sections": [
    {
      "facts": [
        { "name": "Repository",   "value": "___GITHUB_REPOSITORY___" },
        { "name": "Triggered By", "value": "___GITHUB_ACTOR___" },
        { "name": "Event",        "value": "___EVENT_TYPE___" },
        { "name": "Branch/Tag",   "value": "___REF_NAME___" },
        { "name": "Commit SHA",   "value": "___GITHUB_SHA___" },
        { "name": "Commit URL",   "value": "___COMMIT_URL___" }
      ],
      "text": ___COMMIT_MSG_JSON___
    }
  ],
  "potentialAction": [
    {
      "@type": "OpenUri",
      "name": "View Commit",
      "targets": [{ "os": "default", "uri": "___COMMIT_URL___" }]
    },
    {
      "@type": "OpenUri",
      "name": "View Branch/Tag",
      "targets": [{ "os": "default", "uri": "___REF_URL___" }]
    }
  ]
}
EOF

          # Replace placeholders safely
          sed -i \
            -e "s|___TITLE___|${{ inputs.notify_title }}|g" \
            -e "s|___THEME_COLOR___|${{ inputs.theme_color }}|g" \
            -e "s|___EVENT_TYPE___|${EVENT_TYPE}|g" \
            -e "s|___GITHUB_REPOSITORY___|${GITHUB_REPOSITORY}|g" \
            -e "s|___GITHUB_ACTOR___|${GITHUB_ACTOR}|g" \
            -e "s|___REF_NAME___|${REF_NAME}|g" \
            -e "s|___GITHUB_SHA___|${GITHUB_SHA}|g" \
            -e "s|___COMMIT_URL___|${COMMIT_URL}|g" \
            -e "s|___REF_URL___|${REF_URL}|g" \
            -e "s|___COMMIT_MSG_JSON___|${COMMIT_MSG_JSON}|g" \
            "${payload_file}"

          echo "PAYLOAD_FILE=${payload_file}" >> "$GITHUB_ENV"

      - name: Send Teams notification
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.teams_webhook_url }}
        shell: bash
        run: |
          curl -sS -X POST \
               -H "Content-Type: application/json" \
               --data @"${PAYLOAD_FILE}" \
               "${TEAMS_WEBHOOK_URL}"
